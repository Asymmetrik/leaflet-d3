/*! leaflet-hexbin.js Version: 0.1.0 */
!function(){"use strict";L.HexbinLayer=L.Class.extend({options:{radius:10,opacity:.5,geo:function(t){return t.geo},lng:function(t){return t[0]},lat:function(t){return t[1]},colorRange:["#f7fbff","#08306b"]},initialize:function(t){L.setOptions(this,t),this._hexLayout=d3.hexbin().radius(this.options.radius),this._data=[],this._colorScale=d3.scale.linear().range(this.options.colorRange)},onAdd:function(t){this._map=t,this._container=this._initContainer(),t.on({moveend:this._redraw},this),this._redraw()},onRemove:function(t){this._destroyContainer(),t.off({moveend:this._redraw},this),this._container=null,this._map=null,this._data=null},addTo:function(t){return t.addLayer(this),this},_initContainer:function(){var t=null;if(null==this._container){var n=this._map.getPanes().overlayPane;t=d3.select(n).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}return t},_destroyContainer:function(){null!=this._container&&this._container.remove()},_redraw:function(){if(this._map){var t=this._map.getZoom(),n=2*this.options.radius,i=this._getBounds(this._data),e=this._translateBounds(i),a=e.getSize().x+2*n,o=e.getSize().y+2*n,r=e.min.y-n,s=e.min.x-n;this._hexLayout.size([a,o]),this._container.attr("width",a).attr("height",o).style("margin-left",s+"px").style("margin-top",r+"px");var u=this._container.selectAll("g.hexbin").data([t],function(t){return t});u.enter().append("g").attr("class",function(t){return"hexbin zoom-"+t}),u.attr("transform","translate("+-s+","+-r+")"),u.exit().remove(),this._createHexagons(u)}},_createHexagons:function(t){var n=this,i=n._data.map(function(t){var i=n.options.geo(t),e=n.options.lng(i),a=n.options.lat(i);return n._project([e,a])}),e=n._hexLayout(i);n._colorScale.domain([0,e.reduce(function(t,n){return Math.max(t,n.length)},0)]);var a=t.selectAll("path.hexbin-hexagon").data(e,function(t){return t.i+":"+t.j});a.transition().duration(200).attr("fill",function(t){return n._colorScale(t.length)}),a.enter().append("path").attr("class","hexbin-hexagon").attr("d",function(t){return"M"+t.x+","+t.y+n._hexLayout.hexagon()}).attr("fill",function(t){return n._colorScale(t.length)}).attr("opacity",.01).transition().duration(200).attr("opacity",n.options.opacity),a.exit().transition().duration(200).attr("opacity",.01).remove()},_project:function(t){var n=this._map.latLngToLayerPoint([t[1],t[0]]);return[n.x,n.y]},_translateBounds:function(t){var n=this._project([t[0][0],t[1][1]]),i=this._project([t[1][0],t[0][1]]);return L.bounds(n,i)},_getBounds:function(t){var n=this;if(null==t||t.length<1)return[[0,0],[0,0]];var i=[[999,999],[-999,-999]];return t.forEach(function(t){var e=n.options.geo(t),a=n.options.lng(e),o=n.options.lat(e);i[0][0]=Math.min(i[0][0],a),i[0][1]=Math.min(i[0][1],o),i[1][0]=Math.max(i[1][0],a),i[1][1]=Math.max(i[1][1],o)}),i},update:function(t){this._data=null!=t?t:[],this._redraw()}}),L.hexbinLayer=function(t){return new L.HexbinLayer(t)}}();