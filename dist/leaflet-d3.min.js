/*! @asymmetrik/leaflet-d3 - 2.0.0 - Copyright (c) 2007-2017 Asymmetrik Ltd, a Maryland Corporation */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3"),require("d3-hexbin"),require("leaflet")):"function"==typeof define&&define.amd?define(["exports","d3","d3-hexbin","leaflet"],n):n(t.leafletD3=t.leafletD3||{},t.d3,t.d3.hexbin)}(this,function(t,n,i){"use strict";var e=null!=n.hexbin?n.hexbin:null!=i?i.hexbin:null;L.HexbinLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Mixin.Events],options:{radius:12,opacity:.6,duration:200,colorScaleExtent:[1,void 0],radiusScaleExtent:[1,void 0],colorRange:["#f7fbff","#08306b"],radiusRange:[4,12],pointerEvents:"all"},_fn:{lng:function(t){return t[0]},lat:function(t){return t[1]},colorValue:function(t){return t.length},radiusValue:function(t){return Number.MAX_VALUE},fill:function(t){var n=this._fn.colorValue(t);return null!=n?this._scale.color(n):"none"}},_scale:{color:n.scaleLinear(),radius:n.scaleLinear()},_dispatch:n.dispatch("mouseover","mouseout","click"),initialize:function(t){L.setOptions(this,t),this._hexLayout=e().radius(this.options.radius).x(function(t){return t.point[0]}).y(function(t){return t.point[1]}),this._data=[],this._scale.color.range(this.options.colorRange).clamp(!0),this._scale.radius.range(this.options.radiusRange).clamp(!0)},onAdd:function(t){this._map=t,this._initContainer(),t.on({moveend:this.redraw},this),this.redraw()},onRemove:function(t){this._destroyContainer(),t.off({moveend:this.redraw},this),this._container=null,this._map=null},_initContainer:function(){if(null==this._container){var t=this._map.getPanes().overlayPane;this._container=n.select(t).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}},_destroyContainer:function(){null!=this._container&&this._container.remove()},redraw:function(){var t=this;if(t._map){var n=t._data.map(function(n){var i=t._fn.lng(n),e=t._fn.lat(n),a=t._project([i,e]);return{o:n,point:a}}),i=512,e=this._getBounds(n),a=e.max[0]-e.min[0]+2*i,o=e.max[1]-e.min[1]+2*i,r=e.min[1]-i,s=e.min[0]-i;this._container.attr("width",a).attr("height",o).style("margin-left",s+"px").style("margin-top",r+"px");var l=this._container.selectAll("g.hexbin").data([this._map.getZoom()],function(t){return t}),u=l.enter().append("g").attr("class",function(t){return"hexbin zoom-"+t}),h=u.merge(l);h.attr("transform","translate("+-s+","+-r+")"),l.exit().remove(),this._createHexagons(h,n)}},_createHexagons:function(t,n){var i=this,e=i._hexLayout(n),a=i._getExtent(e,i._fn.colorValue,i.options.colorScaleExtent),o=i._getExtent(e,i._fn.radiusValue,i.options.radiusScaleExtent),r=i._linearlySpace(a[0],a[1],i._scale.color.range().length);i._scale.color.domain(r),i._scale.radius.domain(o);var s=t.selectAll("path.hexbin-hexagon").data(e,function(t){return t.x+":"+t.y});s.transition().duration(i.options.duration).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",i.options.opacity).attr("stroke-opacity",i.options.opacity),s.enter().append("path").attr("class","hexbin-hexagon").style("pointer-events",i.options.pointerEvents).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("d",function(t){return i._hexLayout.hexagon(i._scale.radius(i._fn.radiusValue.call(i,t)))}).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",.01).attr("stroke-opacity",.01).on("mouseover",function(t,n){i._dispatch.call("mouseover",this,t,n)}).on("mouseout",function(t,n){i._dispatch.call("mouseout",this,t,n)}).on("click",function(t,n){i._dispatch.call("click",this,t,n)}).transition().duration(i.options.duration).attr("fill-opacity",i.options.opacity).attr("stroke-opacity",i.options.opacity),s.exit().transition().duration(i.options.duration).attr("fill-opacity",.01).attr("stroke-opacity",.01).remove()},_getExtent:function(t,i,e){var a=n.extent(t,i.bind(this));return null==a[0]&&(a[0]=0),null==a[1]&&(a[1]=0),null!=e[0]&&(a[0]=e[0]),null!=e[1]&&(a[1]=e[1]),a},_project:function(t){var n=this._map.latLngToLayerPoint([t[1],t[0]]);return[n.x,n.y]},_getBounds:function(t){if(null==t||t.length<1)return{min:[0,0],max:[0,0]};var n=[[999,999],[-999,-999]];return t.forEach(function(t){var i=t.point[0],e=t.point[1];n[0][0]=Math.min(n[0][0],i),n[0][1]=Math.min(n[0][1],e),n[1][0]=Math.max(n[1][0],i),n[1][1]=Math.max(n[1][1],e)}),{min:n[0],max:n[1]}},_linearlySpace:function(t,n,i){for(var e=new Array(i),a=(n-t)/Math.max(i-1,1),o=0;o<i;++o)e[o]=t+o*a;return e},radius:function(t){return arguments.length?(this.options.radius=t,this._hexLayout.radius(t),this):this.options.radius},opacity:function(t){return arguments.length?(this.options.opacity=t,this):this.options.opacity},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},colorScaleExtent:function(t){return arguments.length?(this.options.colorScaleExtent=t,this):this.options.colorScaleExtent},radiusScaleExtent:function(t){return arguments.length?(this.options.radiusScaleExtent=t,this):this.options.radiusScaleExtent},colorRange:function(t){return arguments.length?(this.options.colorRange=t,this._scale.color().range(t),this):this.options.colorRange},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius().range(t),this):this.options.radiusRange},colorScale:function(t){return arguments.length?(this._scale.color=t,this):this._scale.color},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},colorValue:function(t){return arguments.length?(this._fn.colorValue=t,this):this._fn.colorValue},radiusValue:function(t){return arguments.length?(this._fn.radiusValue=t,this):this._fn.radiusValue},fill:function(t){return arguments.length?(this._fn.fill=t,this):this._fn.fill},data:function(t){return arguments.length?(this._data=null!=t?t:[],this.redraw(),this):this._data},dispatch:function(){return this._dispatch},getLatLngs:function(){var t=this;return this._data.map(function(n){return L.latLng(t.options.lat(n),t.options.lng(n))})},toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"LineString",coordinates:L.GeoJSON.latLngsToCoords(this.getLatLngs(),0)})}}),L.hexbinLayer=function(t){return new L.HexbinLayer(t)},L.PingLayer=(L.Layer?L.Layer:L.Class).extend({includes:[L.Mixin.Events],options:{fps:32,duration:800},_lastUpdate:Date.now(),_fps:0,_mapBounds:void 0,radiusScale:function(t){return void 0===t?this._radiusScale:(this._radiusScale=t,this)},opacityScale:function(t){return void 0===t?this._opacityScale:(this._opacityScale=t,this)},initialize:function(t){L.setOptions(this,t),this._radiusScale=n.scalePow().exponent(.35).domain([0,this.options.duration]).range([3,15]).clamp(!0),this._opacityScale=n.scaleLinear().domain([0,this.options.duration]).range([1,0]).clamp(!0)},onAdd:function(t){this._map=t,this._running=!1,this._container=this._initContainer(),this._updateContainer(),t.on({move:this._move},this)},onRemove:function(t){this._destroyContainer(),t.off({move:this._move},this),this._container=null,this._map=null,this._data=null},ping:function(t,i){if(this._add(t,i),this._expire(),!this._running&&this._data.length>0){this._running=!0,this._lastUpdate=Date.now();var e=this;n.timer(function(){return e._update.apply(e)})}return this},getFps:function(){return this._fps},getCount:function(){return this._data.length},_initContainer:function(){var t=null;if(null==this._container){var i=this._map.getPanes().overlayPane;t=n.select(i).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}return t},_updateContainer:function(){var t=this._getMapBounds();this._mapBounds=t,this._container.attr("width",t.width).attr("height",t.height).style("margin-left",t.left+"px").style("margin-top",t.top+"px"),this._update(!0)},_destroyContainer:function(){null!=this._container&&this._container.remove()},_getMapBounds:function(){var t=this._map.getBounds(),n=this._map.latLngToLayerPoint(t.getNorthEast()),i=this._map.latLngToLayerPoint(t.getSouthWest()),e={width:n.x-i.x,height:i.y-n.y,left:i.x,top:n.y};return e},_getCircleCoords:function(t){var n=this._map.latLngToLayerPoint(t);return{x:n.x-this._mapBounds.left,y:n.y-this._mapBounds.top}},_move:function(){console.log("move"),this._updateContainer()},_add:function(t,n){null==this._data&&(this._data=[]);var i=[this.options.lat(t),this.options.lng(t)],e=this._getCircleCoords(i),a={geo:i,ts:Date.now(),nts:0};a.c=this._container.append("circle").attr("class",null!=n?"ping "+n:"ping").attr("cx",e.x).attr("cy",e.y).attr("r",this.radiusScale().range()[0]),this._data.push(a)},_update:function(t){var n=Date.now();null==this._data&&(this._data=[]);for(var i=-1,e=0;e<this._data.length;e++){var a=this._data[e],o=n-a.ts;if(this.options.duration<o)a.c.remove(),i=e;else if(t||a.nts<n){var r=this._getCircleCoords(a.geo);a.c.attr("cx",r.x).attr("cy",r.y).attr("r",this.radiusScale()(o)).attr("fill-opacity",this.opacityScale()(o)).attr("stroke-opacity",this.opacityScale()(o)),a.nts=Math.round(n+1e3/this.options.fps)}}return i>-1&&this._data.splice(0,i+1),this._running=this._data.length>0,this._running&&(this._fps=1e3/(n-this._lastUpdate),this._lastUpdate=n),!this._running},_expire:function(){for(var t=-1,n=Date.now(),i=0;i<this._data.length;i++){var e=this._data[i],a=n-e.ts;if(!(this.options.duration<a))break;e.c.remove(),t=i}t>-1&&this._data.splice(0,t+1)}}),L.pingLayer=function(t){return new L.PingLayer(t)},Object.defineProperty(t,"__esModule",{value:!0})});