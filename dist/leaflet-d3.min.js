/*! leaflet-d3.js Version: 0.2.7 */
!function(){"use strict";L.HexbinLayer=L.Class.extend({includes:[L.Mixin.Events],options:{radius:10,opacity:.5,duration:200,lng:function(t){return t[0]},lat:function(t){return t[1]},value:function(t){return t.length},valueFloor:void 0,valueCeil:void 0,colorRange:["#f7fbff","#08306b"]},initialize:function(t){L.setOptions(this,t),this._hexLayout=d3.hexbin().radius(this.options.radius).x(function(t){return t.point[0]}).y(function(t){return t.point[1]}),this._data=[],this._colorScale=d3.scale.linear().range(this.options.colorRange).clamp(!0)},onAdd:function(t){this._map=t,this._container=this._initContainer(),t.on({moveend:this._redraw},this),this._redraw()},onRemove:function(t){this._destroyContainer(),t.off({moveend:this._redraw},this),this._container=null,this._map=null,this._data=null},addTo:function(t){return t.addLayer(this),this},_initContainer:function(){var t=null;if(null==this._container){var n=this._map.getPanes().overlayPane;t=d3.select(n).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}return t},_destroyContainer:function(){null!=this._container&&this._container.remove()},_redraw:function(){var t=this;if(t._map){var n=t._data.map(function(n){var i=t.options.lng(n),a=t.options.lat(n),o=t._project([i,a]);return{o:n,point:o}}),i=this._map.getZoom(),a=2*this.options.radius,o=this._getBounds(n),e=o.max[0]-o.min[0]+2*a,r=o.max[1]-o.min[1]+2*a,s=o.min[1]-a,u=o.min[0]-a;this._hexLayout.size([e,r]),this._container.attr("width",e).attr("height",r).style("margin-left",u+"px").style("margin-top",s+"px");var l=this._container.selectAll("g.hexbin").data([i],function(t){return t});l.enter().append("g").attr("class",function(t){return"hexbin zoom-"+t}),l.attr("transform","translate("+-u+","+-s+")"),l.exit().remove(),this._createHexagons(l,n)}},_createHexagons:function(t,n){var i=this,a=i._hexLayout(n),o=d3.extent(a,function(t){return i.options.value(t)});null==o[0]&&(o[0]=0),null==o[1]&&(o[1]=0),null!=i.options.valueFloor&&(o[0]=i.options.valueFloor),null!=i.options.valueCeil&&(o[1]=i.options.valueCeil),i._colorScale.domain(o);var e=t.selectAll("path.hexbin-hexagon").data(a,function(t){return t.i+":"+t.j});e.transition().duration(i.options.duration).attr("fill",function(t){return i._colorScale(i.options.value(t))}).attr("opacity",i.options.opacity),e.enter().append("path").attr("class","hexbin-hexagon").attr("d",function(t){return"M"+t.x+","+t.y+i._hexLayout.hexagon()}).attr("fill",function(t){return i._colorScale(i.options.value(t))}).attr("opacity",.01).transition().duration(i.options.duration).attr("opacity",i.options.opacity),e.exit().transition().duration(i.options.duration).attr("opacity",.01).remove()},_project:function(t){var n=this._map.latLngToLayerPoint([t[1],t[0]]);return[n.x,n.y]},_getBounds:function(t){if(null==t||t.length<1)return{min:[0,0],max:[0,0]};var n=[[999,999],[-999,-999]];return t.forEach(function(t){var i=t.point[0],a=t.point[1];n[0][0]=Math.min(n[0][0],i),n[0][1]=Math.min(n[0][1],a),n[1][0]=Math.max(n[1][0],i),n[1][1]=Math.max(n[1][1],a)}),{min:n[0],max:n[1]}},data:function(t){return this._data=null!=t?t:[],this._redraw(),this},colorScale:function(t){return void 0===t?this._colorScale:(this._colorScale=t,this._redraw(),this)},value:function(t){return void 0===t?this.options.value:(this.options.value=t,this._redraw(),this)}}),L.hexbinLayer=function(t){return new L.HexbinLayer(t)}}(),function(){"use strict";L.PingLayer=L.Class.extend({includes:[L.Mixin.Events],options:{lng:function(t){return t[0]},lat:function(t){return t[1]},fps:8,duration:800},mapBounds:void 0,radiusScale:function(t){return void 0===t?this._radiusScale:(this._radiusScale=t,this)},opacityScale:function(t){return void 0===t?this._opacityScale:(this._opacityScale=t,this)},initialize:function(t){L.setOptions(this,t),this._radiusScale=d3.scale.pow().exponent(.35).domain([0,this.options.duration]).range([3,15]).clamp(!0),this._opacityScale=d3.scale.linear().domain([0,this.options.duration]).range([1,0]).clamp(!0)},onAdd:function(t){this._map=t,this._running=!1,this._container=this._initContainer(),this._updateContainer(),t.on({move:this._move},this)},onRemove:function(t){this._destroyContainer(),t.off({move:this._move},this),this._container=null,this._map=null,this._data=null},addTo:function(t){return t.addLayer(this),this},ping:function(t){if(this._add(t),this._expire(),!this._running&&this._data.length>0){this._running=!0;var n=this;d3.timer(function(){n._update.apply(n)})}return this},_initContainer:function(){var t=null;if(null==this._container){var n=this._map.getPanes().overlayPane;t=d3.select(n).append("svg").attr("class","leaflet-layer leaflet-zoom-hide")}return t},_updateContainer:function(){var t=this._mapBounds();this.mapBounds=t,this._container.attr("width",t.width).attr("height",t.height).style("margin-left",t.left+"px").style("margin-top",t.top+"px")},_destroyContainer:function(){null!=this._container&&this._container.remove()},_mapBounds:function(){var t=this._map.getBounds(),n=this._map.latLngToLayerPoint(t.getNorthEast()),i=this._map.latLngToLayerPoint(t.getSouthWest()),a={width:n.x-i.x,height:i.y-n.y,left:i.x,top:n.y};return a},_move:function(){this._updateContainer()},_add:function(t){null==this._data&&(this._data=[]);var n=[this.options.lat(t),this.options.lng(t)],i=this._map.latLngToLayerPoint(n),a=this.mapBounds,o={geo:n,x:i.x-a.left,y:i.y-a.top,ts:Date.now(),nts:0};o.c=this._container.append("circle").attr("class","ping").attr("cx",o.x).attr("cy",o.y).attr("r",this.radiusScale().range()[0]),this._data.push(o)},_update:function(){var t=Date.now();null==this._data&&(this._data=[]);for(var n=-1,i=0;i<this._data.length;i++){var a=this._data[i],o=t-a.ts;this.options.duration<o?(a.c.remove(),n=i):a.nts<t&&(a.c.attr("r",this.radiusScale()(o)).attr("opacity",this.opacityScale()(o)),a.nts=t+1e3/this.options.fps)}return n>-1&&this._data.splice(0,n+1),this._running=this._data.length>0,!this._running},_expire:function(){for(var t=-1,n=Date.now(),i=0;i<this._data.length;i++){var a=this._data[i],o=n-a.ts;if(!(this.options.duration<o))break;a.c.remove(),t=i}t>-1&&this._data.splice(0,t+1)}}),L.pingLayer=function(t){return new L.PingLayer(t)}}();